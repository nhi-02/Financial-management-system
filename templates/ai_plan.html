{% extends "base.html" %}
{% block title %}K·∫ø ho·∫°ch AI - {{ goal.name }}{% endblock %}
{% block content %}
<div class="form-container" style="max-width: 900px;">
    <h2>üéØ K·∫ø ho·∫°ch ti·∫øt ki·ªám cho: {{ goal.name }}</h2>
    
    <div style="background:#f3f4f6; padding:15px; border-radius:8px; margin-bottom:20px;">
        <p><strong>M·ª•c ti√™u:</strong> {{ goal.targetAmount | format_currency }}</p>
        <p><strong>ƒê√£ c√≥:</strong> {{ goal.currentAmount | format_currency }}</p>
        <p><strong>C√≤n thi·∫øu:</strong> {{ (goal.targetAmount - goal.currentAmount) | format_currency }}</p>
        {% if goal.deadline %}
        <p><strong>Th·ªùi h·∫°n:</strong> {{ goal.deadline | format_date }}</p>
        {% endif %}
    </div>
    
    <button id="generateBtn" class="btn btn-primary" onclick="generatePlan()">
        ‚ú® T·∫°o k·∫ø ho·∫°ch b·∫±ng AI
    </button>
    
    <div id="loading" style="display:none; text-align:center; margin:30px 0;">
        <p>‚è≥ ƒêang t·∫°o k·∫ø ho·∫°ch... (10-20 gi√¢y)</p>
    </div>
    
    <div id="result" style="display:none; margin-top:30px;">
        <h3>üìã K·∫ø ho·∫°ch c·ªßa b·∫°n:</h3>
        <div id="planContent" style="background:#f9fafb; padding:20px; border-radius:8px; white-space:pre-wrap; line-height:1.8;">
        </div>
    </div>
    
    <div id="error" style="display:none; margin-top:20px;" class="alert alert-error"></div>
    
    <div style="margin-top:30px;">
        <a href="{{ url_for('index') }}" class="btn btn-secondary">Quay l·∫°i</a>
    </div>
</div>

<script>
async function generatePlan() {
    const btn = document.getElementById('generateBtn');
    const loading = document.getElementById('loading');
    const result = document.getElementById('result');
    const error = document.getElementById('error');
    const content = document.getElementById('planContent');
    
    btn.disabled = true;
    loading.style.display = 'block';
    result.style.display = 'none';
    error.style.display = 'none';
    
    try {
        const response = await fetch('/ai/plan/{{ goal.id }}/generate', { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
            content.innerHTML = data.plan.replace(/\n/g, '<br>');
            result.style.display = 'block';
        } else {
            error.textContent = 'L·ªói: ' + (data.error || 'Kh√¥ng th·ªÉ t·∫°o k·∫ø ho·∫°ch');
            error.style.display = 'block';
        }
    } catch (err) {
        error.textContent = 'L·ªói k·∫øt n·ªëi: ' + err.message;
        error.style.display = 'block';
    } finally {
        btn.disabled = false;
        loading.style.display = 'none';
    }
}
</script>
{% endblock %}