{% extends "base.html" %}
{% block title %}PhÃ¢n tÃ­ch{% endblock %}
{% block content %}

<div class="analysis-header">
  <form method="get">
    <input type="month" name="month" value="{{ month }}">
    <button type="submit">Xem</button>
  </form>
</div>

<div class="chart-wrapper">

  <!-- Biá»ƒu Ä‘á»“ Ä‘Æ°á»ng (máº·c Ä‘á»‹nh) -->
  <canvas id="lineChart"></canvas>

  <!-- Biá»ƒu Ä‘á»“ trÃ²n -->
  <canvas id="pieChart" class="hidden"></canvas>

  <div class="chart-nav">
    <button onclick="showLine()">ğŸ“ˆ Theo thá»i gian</button>
    <button onclick="showExpense()">Chi tiÃªu</button>
    <button onclick="showIncome()">Thu nháº­p</button>
  </div>

</div>

<script>
const dailyData = {{ daily_data | tojson }};
const expenseData = {{ expense_data | tojson }};
const incomeData = {{ income_data | tojson }};
</script>

<script>
let chart = null;

function showLine() {
  document.getElementById('lineChart').classList.remove('hidden');
  document.getElementById('pieChart').classList.add('hidden');

  if (chart) chart.destroy();

  chart = new Chart(document.getElementById('lineChart'), {
    type: 'line',
    data: {
      labels: dailyData.map(d => d.date),
      datasets: [
        {
          label: 'Chi tiÃªu',
          data: dailyData.map(d => d.expense),
          borderWidth: 2
        },
        {
          label: 'Thu nháº­p',
          data: dailyData.map(d => d.income),
          borderWidth: 2
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'bottom' }
      }
    }
  });
}

function showPie(data, title) {
  document.getElementById('lineChart').classList.add('hidden');
  document.getElementById('pieChart').classList.remove('hidden');

  if (chart) chart.destroy();

  chart = new Chart(document.getElementById('pieChart'), {
    type: 'pie',
    data: {
      labels: data.map(d => d.category),
      datasets: [{
        data: data.map(d => d.total)
      }]
    },
    options: {
      plugins: {
        title: { display: true, text: title },
        legend: { position: 'bottom' }
      }
    }
  });
}

function showExpense() {
  showPie(expenseData, 'Chi tiÃªu theo danh má»¥c');
}

function showIncome() {
  showPie(incomeData, 'Thu nháº­p theo danh má»¥c');
}

// Máº·c Ä‘á»‹nh
showLine();
</script>



<div class="transaction-list">
  {% set current_date = None %}

  {% for t in transactions %}
    {% if t.date != current_date %}
      <div class="transaction-date">
        ğŸ“… {{ t.date }}
      </div>
      {% set current_date = t.date %}
    {% endif %}

    <div class="transaction-item {{ t.type }}">
      <div class="left">
        <span class="icon">
          {% if t.type == 'expense' %}â–{% else %}â•{% endif %}
        </span>
        <div>
          <strong>{{ t.categoryName }}</strong><br>
          <small>{{ t.note }}</small>
        </div>
      </div>

      <div class="amount">
        {{ t.amount | format_currency }}
      </div>
    </div>
  {% endfor %}
</div>
{% endblock %}
